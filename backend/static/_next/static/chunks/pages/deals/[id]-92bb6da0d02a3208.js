(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[737],{2330:(e,t,n)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/deals/[id]",function(){return n(7585)}])},7585:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>T});var a=n(7876),s=n(9099),i=n(4232),r=n(870),l=n(9563),p=n(695),u=n(2858),d=n(4587),o=n.n(d);let y=JSON.parse('{"HV":[{"inputs":[{"internalType":"uint256","name":"initialSupply","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"allowance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"}],"name":"ERC20InsufficientAllowance","type":"error"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"}],"name":"ERC20InsufficientBalance","type":"error"},{"inputs":[{"internalType":"address","name":"approver","type":"address"}],"name":"ERC20InvalidApprover","type":"error"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC20InvalidReceiver","type":"error"},{"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"ERC20InvalidSender","type":"error"},{"inputs":[{"internalType":"address","name":"spender","type":"address"}],"name":"ERC20InvalidSpender","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}]}'),c=JSON.parse('{"HV":[{"inputs":[{"internalType":"contract IERC20","name":"_token","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"beneficiary","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"createEscrow","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"deposits","outputs":[{"internalType":"address","name":"depositor","type":"address"},{"internalType":"address","name":"beneficiary","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"released","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"release","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"}]}');var m=n(5364);function f(e){let{supplierAddress:t,pricePerKg:n,onSuccess:s}=e,[r,d]=(0,i.useState)(0),[f,T]=(0,i.useState)(null),[x,b]=(0,i.useState)(null),[w,h]=(0,i.useState)(!1),[v,g]=(0,i.useState)(null),j=m.env.NEXT_PUBLIC_GLU_TOKEN_ADDRESS,N=m.env.NEXT_PUBLIC_ESCROW_ADDRESS;(0,i.useEffect)(()=>{if(!window.ethereum)return void g("Please install MetaMask.");let e=new l.j(window.ethereum,{name:"localhost",chainId:31337});e.send("eth_requestAccounts",[]).then(()=>{let t=e.getSigner();T(new p.NZ(j,y.HV,t)),b(new p.NZ(N,c.HV,t))}).catch(()=>g("Wallet connection failed"))},[j,N]);let _=async()=>{if(g(null),r<=0)return void g("Enter a positive quantity");if(!f||!x)return void g("Wallet not connected");h(!0);try{let e=u.XS((r*n).toString(),18),a=await f.approve(N,e);await a.wait();let i=await x.createEscrow(t,e);await i.wait(),s()}catch(t){var e;g(null!=(e=t.message)?e:"Transaction failed")}finally{h(!1)}};return(0,a.jsxs)("div",{className:"p-4 border rounded bg-gray-50 flex flex-col space-y-4",children:[(0,a.jsxs)("label",{className:"block",children:[(0,a.jsx)("span",{className:"mb-1 font-medium block",children:"Quantity (kg):"}),(0,a.jsx)("input",{type:"number",value:r||"",onChange:e=>d(parseFloat(e.target.value)),className:"w-24 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary",min:"0",step:"0.01"})]}),(0,a.jsxs)("p",{className:"flex items-center text-lg",children:[(0,a.jsx)("span",{className:"mr-2",children:"Total GLU:"}),(0,a.jsxs)("strong",{className:"inline-flex items-center",children:[(r*n).toFixed(2),(0,a.jsx)(o(),{src:"/glu.svg",alt:"GLU token",width:20,height:20,className:"ml-1",priority:!0})]})]}),v&&(0,a.jsx)("p",{className:"text-red-600",children:v}),(0,a.jsxs)("button",{onClick:_,disabled:w,className:"inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50",children:[(0,a.jsx)(o(),{src:"/glu.svg",alt:"GLU",width:16,height:16,className:"mr-2",priority:!0}),w?"Processing…":"Lock GLU in Escrow"]})]})}function T(){let{id:e}=(0,s.useRouter)().query,[t,n]=(0,i.useState)(null),[l,p]=(0,i.useState)(!0),[u,d]=(0,i.useState)(null);(0,i.useEffect)(()=>{(async()=>{if(e){p(!0),d(null);try{let{data:t}=await r.A.get("/deals/".concat(e));n(t)}catch(e){var t,a;d((null==(a=e.response)||null==(t=a.data)?void 0:t.detail)||e.message)}finally{p(!1)}}})()},[e]);let o=async()=>{if(e)try{await r.A.put("/deals/".concat(e,"/status"),{status:"confirmed"});let{data:t}=await r.A.get("/deals/".concat(e));n(t)}catch(e){var t,a;alert((null==(a=e.response)||null==(t=a.data)?void 0:t.detail)||"Could not confirm escrow")}},y=async()=>{if(e)try{await r.A.post("/deals/".concat(e,"/release"));let{data:t}=await r.A.get("/deals/".concat(e));n(t)}catch(e){var t,a;alert((null==(a=e.response)||null==(t=a.data)?void 0:t.detail)||"Release failed")}};return l?(0,a.jsx)("p",{className:"p-6 text-center",children:"Loading…"}):u?(0,a.jsx)("p",{className:"p-6 text-center text-red-600",children:u}):t?(0,a.jsxs)("main",{className:"pt-0",children:[" ",(0,a.jsxs)("div",{className:"max-w-xl mx-auto p-4",children:[(0,a.jsxs)("h1",{className:"text-2xl font-bold mb-4",children:["Deal #",t.id]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Product:"})," ",t.product_title]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Quantity:"})," ",t.quantity_kg," kg"]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Total:"})," $",t.total_price]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Status:"})," ",t.status]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Created at:"})," ",new Date(t.created_at).toLocaleString()]}),"negotiation"===t.status&&(0,a.jsx)(f,{supplierAddress:t.supplier_wallet_address,pricePerKg:t.total_price/t.quantity_kg,onSuccess:o}),"confirmed"===t.status&&(0,a.jsx)("button",{className:"mt-4 bg-red-500 text-white px-4 py-2 rounded",onClick:y,children:"Release Funds"})]})]}):(0,a.jsx)("p",{className:"p-6 text-center",children:"Deal not found"})}}},e=>{var t=t=>e(e.s=t);e.O(0,[677,224,636,593,792],()=>t(2330)),_N_E=e.O()}]);