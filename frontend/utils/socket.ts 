// frontend/utils/socket.ts

// âœ… Ensure this file only runs in the browser
if (typeof window === "undefined") {
  throw new Error("WebSocket client attempted to run on the server.");
}

// âœ… Define a typed interface for incoming WebSocket messages
interface ContainerMessage {
  event: string;
  containerId?: string;
  cubes?: Record<string, any>;
  [key: string]: any;
}

// âœ… Initialize the WebSocket
const socket = new WebSocket(
  window.location.protocol === "https:"
    ? `wss://${window.location.host}/ws/containers`
    : `ws://${window.location.host}/ws/containers`
);

// âœ… Listener registry
const listeners: Array<(msg: ContainerMessage) => void> = [];

// âœ… Connection events
socket.addEventListener("open", () => {
  console.log("âœ… WebSocket connection opened.");
});

socket.addEventListener("close", () => {
  console.warn("ðŸ”Œ WebSocket connection closed.");
});

socket.addEventListener("error", (err) => {
  console.error("âŒ WebSocket error:", err);
});

// âœ… Incoming message handler
socket.addEventListener("message", (event) => {
  try {
    const msg: ContainerMessage = JSON.parse(event.data);

    // ðŸ” Dispatch to registered listeners
    for (const listener of listeners) {
      try {
        listener(msg);
      } catch (e) {
        console.error("Listener error:", e);
      }
    }

    // â³ Trigger a container bundle if requested
    if (msg.event === "trigger_bundle_send" && msg.containerId) {
      fetch(`/api/aion/bundle/${msg.containerId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ container_id: msg.containerId }),
      })
        .then((res) => res.json())
        .then((res) => console.log("ðŸ“¦ Bundle Sent:", res))
        .catch((err) => console.error("âŒ Bundle Send Error:", err));
    }

    // ðŸ”„ Log glyph updates (if needed for debugging)
    if (msg.event === "glyph_update" && msg.cubes) {
      console.log("ðŸ”„ Glyph Update Received");
    }

  } catch (err) {
    console.error("âŒ WebSocket message error:", err);
  }
});

// âœ… Public API
export const addWebSocketListener = (cb: (msg: ContainerMessage) => void) => {
  listeners.push(cb);
};

export const removeWebSocketListener = (cb: (msg: ContainerMessage) => void) => {
  const idx = listeners.indexOf(cb);
  if (idx !== -1) listeners.splice(idx, 1);
};

export default socket;